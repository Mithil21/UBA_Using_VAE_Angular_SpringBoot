import json
import sys
import numpy as np
from sklearn.ensemble import IsolationForest

class MalwareDetector:
    def __init__(self):
        self.model = IsolationForest(contamination=0.1, random_state=42)
        self.trained = False
    
    def extract_features(self, indicators):
        features = []
        
        # Device fingerprint entropy
        fingerprint = indicators.get('deviceFingerprint', '')
        features.append(len(set(fingerprint)) / max(len(fingerprint), 1))
        
        # Suspicious extensions count
        suspicious_ext = indicators.get('suspiciousExtensions', [])
        features.append(len(suspicious_ext))
        
        # Automated traffic indicator
        features.append(1 if indicators.get('automatedTraffic', False) else 0)
        
        # Browser integrity
        features.append(0 if indicators.get('browserIntegrity', True) else 1)
        
        # User agent analysis
        user_agent = indicators.get('userAgent', '')
        features.append(1 if 'bot' in user_agent.lower() else 0)
        features.append(1 if 'headless' in user_agent.lower() else 0)
        
        return np.array(features).reshape(1, -1)
    
    def detect(self, indicators):
        try:
            features = self.extract_features(indicators)
            
            # Simple rule-based detection for immediate threats
            suspicious_ext = indicators.get('suspiciousExtensions', [])
            if len(suspicious_ext) > 0:
                return True
            
            if indicators.get('automatedTraffic', False):
                return True
            
            if not indicators.get('browserIntegrity', True):
                return True
            
            # Train model with current data if not trained
            if not self.trained:
                # Create synthetic training data
                normal_data = np.random.normal(0, 1, (100, features.shape[1]))
                self.model.fit(normal_data)
                self.trained = True
            
            # Predict anomaly
            prediction = self.model.predict(features)
            return prediction[0] == -1  # -1 indicates anomaly
            
        except Exception as e:
            return False

def main():
    if len(sys.argv) != 2:
        print("false")
        sys.exit(1)
    
    try:
        indicators = json.loads(sys.argv[1])
        detector = MalwareDetector()
        result = detector.detect(indicators)
        print("true" if result else "false")
        
    except Exception as e:
        print("false")

if __name__ == "__main__":
    main()